<!--
/*******************************************************************************
#      ____               __          __  _      _____ _       _               #
#     / __ \              \ \        / / | |    / ____| |     | |              #
#    | |  | |_ __   ___ _ __ \  /\  / /__| |__ | |  __| | ___ | |__   ___      #
#    | |  | | '_ \ / _ \ '_ \ \/  \/ / _ \ '_ \| | |_ | |/ _ \| '_ \ / _ \     #
#    | |__| | |_) |  __/ | | \  /\  /  __/ |_) | |__| | | (_) | |_) |  __/     #
#     \____/| .__/ \___|_| |_|\/  \/ \___|_.__/ \_____|_|\___/|_.__/ \___|     #
#           | |                                                                #
#           |_|                 _____ _____  _  __                             #
#                              / ____|  __ \| |/ /                             #
#                             | (___ | |  | | ' /                              #
#                              \___ \| |  | |  <                               #
#                              ____) | |__| | . \                              #
#                             |_____/|_____/|_|\_\                             #
#                                                                              #
#                              (c) 2011-2012 by                                #
#           University of Applied Sciences Northwestern Switzerland            #
#                     Institute of Geomatics Engineering                       #
#                          Author:robert.wst@gmail.com                         #
********************************************************************************
*     Licensed under MIT License. Read the file LICENSE for more information   *
*******************************************************************************/
                      GeoGame: Prototype
*******************************************************************************/-->
<!DOCTYPE html>
<html>
<head>
    <script type="text/javascript" src="source/jquery-1.7.1.min.js"></script>
    <script type="text/javascript" src="../WebViewer/compiled/owg-optimized.js"></script>
    <script type="text/javascript" src="source/kineticjs.js"></script>
    <!--<script type="text/javascript" src="compiled/globegame-optimized.js"></script>-->
    <script type="text/javascript" src="external/closure-library/closure/goog/base.js"></script>
    <script type="text/javascript" src="compiled/deps.js"></script>
    <script type="text/javascript">goog.require('owg.gg.GlobeGame');</script>
    <link href="style.css" rel="stylesheet" type="text/css" />
</head>
<body style="overflow:hidden;" onload="Init()">
<div id="owg_div" style="float:left">
    <div id="main_ui" style="position: absolute;  width: 100%;height: 100%; z-index: 100; visibility: hidden; cursor: pointer"></div>
    <canvas id="canvas">

    </canvas>
</div>
<div style="background-color:#FFF;position:absolute; width: 350px; padding:5px; z-index: 101; float:right; right:0px">
    <h2>OWG Spiel: Challenge Editor</h2><br/>
    <input id="testbtn" class="edbutton" type="button" style="width:150px; height: 25px; visibility: visible" value="Test" onclick="ShowChallenge()"/>
    <input id="resetbtn" class="edbutton" type="button" style="width:150px; height: 25px; visibility: visible" value="Reset" onclick="HideChallenge()"/><br/>
    <input type="checkbox" onchange="TrafficLayer(this.checked)">OSM Layer einblenden</input><br/>
    <b>Typ der Aufgabe: </b><select name="ctype" onchange="TypeChanged(this.value)">
        <option value="landmark">Wissensaufgabe</option>
        <option value="picking">Positionsfindung</option>
    </select><br/><hr/>
    <b>Details:</b>
    <div id="picking_div" style="visibility: hidden; position: absolute">
        <table>
            <tr>
                <td>Punkte: </td><td><input id="qscore" type="number" value="100"/></td>
            </tr>
            <tr>
                <td>Beschreibung: </td><td><input id="location" type="text" value="Test Title" /></td>
            </tr>
        </table>
    </div>
    <div id="landmark_div" style="visibility: visible">
    <table>
        <tr>
            <td>Antwort 1: </td><td><input id="option1" type="text" value="Option1"/></td>
        </tr>
        <tr>
            <td>Antwort 2: </td><td><input id="option2" type="text" value="Option2"/></td>
        </tr>
        <tr>
            <td>Antwort 3: </td><td><input id="option3" type="text" value="Option3"/></td>
        </tr>
        <tr>
            <td>Antwort 4: </td><td><input id="option4" type="text" value="Option4"/></td>
        </tr>
        <tr>
            <td>L&ouml;sungsantwort(1-4): </td><td><input id="correctoption" type="number" value="1"/></td>
        </tr>
        <tr>
            <td>Punkte: </td><td><input id="basescore" type="number" value="100"/></td>
        </tr>
        <tr>
            <td>Beschreibung: </td><td><input id="title" type="text" value="Test Title" /></td>
        </tr>
    </table>
    <b>Ansichten verwalten:</b><br/>
    <input class="edbutton" type="button" style="width:150px; height: 25px" value="Hinzuf&uuml;gen" onclick="AddView()"/><input class="edbutton" type="button" style="width:150px; height: 25px" value="Leeren" onclick="ClearViews()"/>
    <br/>Current:<span id="current"></span></div><hr/>
    <b>Ausgabe:</b>
    <textarea id="output" style="height:400px; width: 350px;background-color: #ffffee;" onclick="SelectAllText('output')"></textarea>
</div>


<script type="text/javascript">
    ogSetArtworkDirectory("../WebViewer/art/");
    function SelectAllText(id)
    {
        document.getElementById(id).focus();
        document.getElementById(id).select();
    }

    /* Members */
    var m_images = {};
    var m_loadedImages = 0;
    var m_numImages = 0;
    var m_context = ogCreateContextFromCanvas("canvas", true);
    var m_globe = ogCreateGlobe(m_context);
    var m_stage = new Kinetic.Stage("main_ui", window.innerWidth, window.innerHeight);
    var m_ui = new Kinetic.Layer();
    var m_centerX = (window.innerWidth-350)/2;
    var m_centerY = window.innerHeight/2;
    var challenge = null;
    var m_picking = null;
    var m_cType = 0;
    var trLayer = null;
    var pkLayer = null;

    /* preload functions */
    function LoadImages(sources){
        // get num of sources
        for (var src in sources) {
            m_numImages++;
        }
        for (var src in sources) {
            m_images[src] = new Image();
            /*m_images[src].onload = function(){
             if (++m_loadedImages >= m_numImages) {
             callback(images);
             }
             };*/
            m_images[src].src = sources[src];
        }
    }


    /* init game */
    function Init() {
        // Preload images
        var sources = {
            btn_01: "art/btn_01.png",
            btn_01_c: "art/btn_01_c.png",
            btn_01_h: "art/btn_01_h.png",
            btn_01_d: "art/btn_01_d.png",
            btn_01_f: "art/btn_01_f.png",
            btn_01_t: "art/btn_01_t.png",
            btn_01_o: "art/btn_01_o.png",
            clock: "art/clock.png",
            dial: "art/dial.png",
            pin_blue: "art/pin_blue.png",
            pin_red: "art/pin_red.png",
            pin_green: "art/pin_green.png",
            pin_yellow: "art/pin_yellow.png"
        };
        LoadImages(sources);

        // Add OWG Data
         ogAddImageLayer(m_globe, {
         url: ["http://www.openwebglobe.org/data/img"],
         layer: "World500",
         service: "i3d"
         });
         ogAddImageLayer(m_globe, {
         url: ["http://10.42.2.37"],
         layer: "swissimage",
         service: "owg"
         });
         ogAddElevationLayer(m_globe, {
         url: ["http://10.42.2.37"],
         layer: "DHM25",
         service: "owg"
         });
        ogSetRenderQuality(m_globe, 2);
        ogSetRenderFunction(m_context, OnRender);
        ogSetResizeFunction(m_context, OnResize);
        var scene = ogGetScene(m_context);
        var camId = ogGetActiveCamera(scene);
        ogSetPosition(camId,8.225578,46.8248707, 280000.0);
        ogSetOrientation(camId,0.0,-90.0, 0.0);
        ogSetCanvasSizeOffset(scene, 360, 1);
        m_stage.add(m_ui);
        m_stage.onFrame(function(frame){
            OnCanvasRender(frame);
        });
        m_stage.start();
    }

    function TypeChanged(type)
    {
        if(type == "landmark")
        {
            jQuery('#picking_div').css("visibility", "hidden");
            jQuery('#landmark_div').css("visibility", "visible");
            jQuery('#testbtn').css("visibility", "visible");
            jQuery('#resetbtn').css("visibility", "visible");
            if(m_picking)
            {
                m_picking.Destroy();
            }
            m_cType = 0;
            if(pkLayer)
            {
                ogRemoveImageLayer(pkLayer);
            }
        }
        else if(type == "picking")
        {
            jQuery('#picking_div').css("visibility", "visible");
            jQuery('#landmark_div').css("visibility", "hidden");
            jQuery('#testbtn').css("visibility", "hidden");
            jQuery('#resetbtn').css("visibility", "hidden");
            m_picking = new PickPosition();
            m_picking.Init();
            m_cType = 1;
            pkLayer = ogAddImageLayer(m_globe, {
                url: ["http://10.42.2.37"],
                layer: "ch_boundaries",
                service: "owg"
            });
        }
    }
    function TrafficLayer(enabled)
    {
        if(enabled)
        {
            trLayer = ogAddImageLayer(m_globe, {
                url: ["http://10.42.2.37"],
                layer: "osm_transparent",
                service: "owg"
            });
        }
        else
        {
            ogRemoveImageLayer(trLayer);
        }
    }


    //-----------------------------------------------------------------------------
    function PickPosition()
    {
        var that = this;
        this.olay = null;
        this.posPin = null;
        this.pickPos = [true,0,0,0];
        this.flystate = false;
        this.zoomState = false;
        this.GetLng = function() { return that.pickPos[1]; };
        this.GetLat = function() { return that.pickPos[2]; };
        this.GetElv = function() { return that.pickPos[3]; };
        this.Init = function()
        {
            jQuery('#main_ui').css("visibility", "visible");
            that.olay = new Kinetic.Rect({
                x: 0,
                y: 0,
                width: window.innerWidth,
                height: window.innerHeight
            });
            that.olay.on("mousedown", that.OnMouseDown);
            that.olay.on("mouseup", that.OnMouseUp);
            that.olay.on("mousemove", that.OnMouseMove);
            m_ui.add(that.olay);
            var scene = ogGetScene(m_context);
            var camId = ogGetActiveCamera(scene);
            ogSetPosition(camId,8.225578,46.8248707, 280000.0);
            ogSetOrientation(camId,0.0,-90.0, 0.0);
            ogSetInPositionFunction(m_context,this.FlightCallback);
        };

        this.Destroy = function()
        {
            that.posPin.Destroy();
            m_ui.remove(that.olay);
            jQuery('#main_ui').css("visibility", "hidden");
        };
        this.FlightCallback = function()
        {
            that.flystate = false;
            var scene = ogGetScene(m_context);
            var pos = ogWorldToWindow(scene,that.pickPos[4],that.pickPos[5],that.pickPos[6]);
            that.posPin.SetVisible(true);
            that.posPin.SetPos(pos[0], pos[1]);
        };

        this.OnMouseDown = function()
        {
            var pos = m_stage.getMousePosition();
            var scene = ogGetScene(m_context);
            if(that.posPin)
                that.posPin.SetPos(pos.x, pos.y);
            if(that.flystate == true)
            {
                ogStopFlyTo(scene);
            }
            var ori = ogGetOrientation(scene);
            var result = ogPickGlobe(scene, pos.x, pos.y);
            that.ZoomIn(result, ori);
            if(that.posPin == null)
            {
                that.posPin = new Pin(m_ui, m_images["pin_blue"], pos.x, pos.y);
            }
            that.zoomState = true;
        };

        this.OnMouseUp = function()
        {
            var scene = ogGetScene(m_context);
            that.zoomState = false;
            var pos = m_stage.getMousePosition();
            var mx = pos.x-10;
            var my = pos.y-10;
            that.pickPos = ogPickGlobe(scene, pos.x, pos.y);
            that.posPin.SetVisible(false);
            if(that.flystate == true)
            {
                ogStopFlyTo(scene);
            }
            that.ZoomOut();
        };
        this.OnMouseMove = function()
        {
            if(that.zoomState == true)
            {
                var pos = m_stage.getMousePosition();
                that.posPin.SetPos(pos.x, pos.y);
            }
        };
        this.ZoomIn = function(pos, ori)
        {
            this.flystate = true;
            var scene = ogGetScene(m_context);
            ogSetFlightDuration(scene,1000);
            ogFlyToLookAtPosition(scene,pos[1],pos[2], pos[3],20000,0.00,-90.0, 0.0);
        };
        this.ZoomOut = function(ori)
        {
            this.flystate = true;
            var scene = ogGetScene(m_context);
            ogSetFlightDuration(scene,800);
            ogFlyTo(scene,8.225578,46.8248707, 280000.0,0.00,-90.0, 0.0);
        };
    }

    function ViewObj(long,lat,elev,yaw,pitch,roll){
        this.longitude = long;
        this.latitude = lat;
        this.elevation = elev;
        this.yaw = yaw;
        this.pitch = pitch;
        this.roll = roll;
    }

    var m_views = [];

    function AddView()
    {
        var scene = ogGetScene(m_context);
        var ori = ogGetOrientation(scene);
        var pos = ogGetPosition(scene);
        var view = new ViewObj(pos["longitude"],pos["latitude"],pos["elevation"],ori["yaw"],ori["pitch"],ori["roll"]);
        m_views.push(view);

    }

    function Update()
    {
        var val = jQuery.parseJSON(document.getElementById('output').innerHTML);
        if(m_cType == 0)
        {
            challenge = new LandmarkChallenge(val.BaseScore, val.Options, val.CorrectOption, val.Views, val.Title);
            challenge.editormode = true;
            challenge.Activate();
        }else
        {
          /*  var pos = [ val.Longitude, val.Latitude, val.Elevation ];
            challenge = new PickingChallenge(val.BaseScore, val.Title, pos);
            challenge.editormode = true;
            challenge.Activate();*/
        }
    }
    function ClearViews()
    {
        m_views = [];
    }

    function ShowChallenge()
    {
        if(m_cType == 0)
        {
            jQuery('#main_ui').css("visibility", "visible");
            Update();
        }
    }

    function HideChallenge()
    {
        if(challenge)
        {
            challenge.Destroy();
        }

        var scene = ogGetScene(m_context);
        var camId = ogGetActiveCamera(scene);
        ogSetPosition(camId,8.225578,46.8248707, 280000.0);
        ogSetOrientation(camId,0.0,-90.0, 0.0);
        setTimeout(function(){
            if(m_cType==0)
            {
                jQuery('#main_ui').css("visibility", "hidden");
            }
            else
            {
                m_picking.posPin.SetVisible(true);
            }
        },1000);
    }

    /* Render Callback */
    function OnCanvasRender(frame)
    {
        m_stage.draw();
    }

    function OnRender(context)
    {
        var scene = ogGetScene(m_context);
        var ori = ogGetOrientation(scene);
        var pos = ogGetPosition(scene);
        document.getElementById('current').innerText = "yaw="+ori["yaw"]+" pitch="+ori["pitch"]+" roll="+ori["roll"] +
                "lng="+pos["longitude"]+" lat="+pos["latitude"]+" elev="+pos["elevation"];
        if(m_cType == 0)
        {
            var out = "{\n"+
                    "   \"Type\": 0,\n"+
                    "   \"BaseScore\": " + document.getElementById('basescore').value + ",\n"+
                    "   \"Title\": \"" + document.getElementById('title').value + "\",\n"+
                    "   \"CorrectOption\": " + document.getElementById('correctoption').value + ",\n"+
                    "   \"Options\": [\"" + document.getElementById('option1').value + "\", \""+document.getElementById('option2').value + "\", \""+document.getElementById('option3').value + "\", \""+document.getElementById('option4').value + "\"],\n"+
                    "   \"Views\": [\n";
            for(var i = 0; i<m_views.length; i++){
                out = out + "       { \"longitude\": "+m_views[i].longitude+",\n        \"latitude\": "+m_views[i].latitude+",\n        \"elevation\": "+m_views[i].elevation+",\n " +
                        "       \"yaw\": "+m_views[i].yaw+",\n        \"pitch\": "+m_views[i].pitch+",\n        \"roll\": "+m_views[i].roll+"\n       }";
                if(i < m_views.length -1)
                {
                    out = out + ",\n";
                }
            }
            out = out + "   \n]\n}";
        }
        else if(m_cType == 1)
        {
            var out = "{\n"+
                    "   \"Type\": 1,\n"+
                    "   \"BaseScore\": " + document.getElementById('basescore').value + ",\n"+
                    "   \"Title\": \"" + document.getElementById('title').value + "\",\n"+
                    "   \"Longitude\": " + m_picking.GetLng() + ",\n"+
                    "   \"Latitude\": " + m_picking.GetLat() + ",\n"+
                    "   \"Elevation\": " + m_picking.GetElv() + "\n"+
                    "\n}";
        }


        document.getElementById('output').innerHTML = out;
    }

    function OnResize(context)
    {
        //var scene = ogGetScene(context);
        //ogSetSize(scene, window.innerWidth/2,window.innerHeight);
        m_centerX = (window.innerWidth-350)/2;
        m_centerY = window.innerHeight/2;
        m_stage.setSize(window.innerWidth-350, window.innerHeight);
    }



</script>
</body>
</html>
